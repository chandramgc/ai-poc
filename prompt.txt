You are an expert MCP (Model Context Protocol) engineer, backend architect, and AI agent designer.

ğŸ“Œ GOAL:
Build a full AI application where:

1. User sends NATURAL LANGUAGE as an HTTP request to /query endpoint.
2. Agent converts natural language â†’ SQL (using LLM API).
3. Agent sends SQL to the MCP Server using **WebSocket (MCP protocol)**.
4. MCP Server runs SQL on PostgreSQL and returns data.
5. Agent returns JSON result to HTTP caller.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Architectural Rules
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- MCP Server = WebSocket transport (MCP-compliant)
- Agent = HTTP REST API (FastAPI)
- Agent must communicate to MCP server using **WebSocket**
- NLP â†’ SQL conversion happens at the agent layer (not inside MCP server)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Project Structure (use Poetry)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

mcp-postgres-ai/
  â”œâ”€ pyproject.toml
  â”œâ”€ README.md
  â”œâ”€ .env.example
  â”œâ”€ docker-compose.yml
  â”œâ”€ Dockerfile
  â””â”€ src/
      â”œâ”€ mcp_server/
      â”‚   â”œâ”€ config.py
      â”‚   â”œâ”€ db.py
      â”‚   â”œâ”€ tools.py           # register run_sql tool
      â”‚   â”œâ”€ ws_server.py       # WebSocket MCP implementation
      â”‚   â””â”€ main.py            # starts WebSocket MCP server
      â””â”€ agent/
          â”œâ”€ http_api.py        # FastAPI HTTP endpoint /query
          â””â”€ ws_client.py       # connects to MCP over WebSocket

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… TECH REQUIREMENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1) Dependency management MUST be Poetry (pyproject.toml only)
   Required libraries:
   - asyncpg
   - fastapi
   - uvicorn
   - websockets
   - python-dotenv
   - pydantic
   - httpx (used by agent if needed)
   - openai (LLM API for NLâ†’SQL)

2) MCP TOOL (tools.py)
   Tool name: `run_sql`
   Input JSON:
     { "query": "...", "params": [] }
   Output JSON:
     { "rows": [...], "rowCount": 10, "executionTimeMs": 2 }

   Enforce:
     - Parameterized queries only
     - **SELECT only** (deny INSERT/UPDATE/DELETE/DROP/ALTER)

3) WebSocket MCP Server (ws_server.py)
   - Path: `/mcp`
   - Port: **9001**
   - Require header:  X-API-Key: <key>
   - On connect â†’ send MCP tool registry JSON
   - On message â†’ call run_sql() â†’ return response

4) Agent (HTTP)
   - Endpoint: POST /query
   - Request:   { "question": "show last 5 users" }
   - Steps:
       (1) Call LLM â†’ Convert NL â†’ SQL
       (2) Connect to MCP WebSocket
       (3) Send MCP request to run_sql
       (4) Return JSON response to HTTP caller
   - SQL validation: only allow SELECT

5) Environment vars (.env.example)
   POSTGRES_HOST=
   POSTGRES_PORT=
   POSTGRES_DB=
   POSTGRES_USER=
   POSTGRES_PASSWORD=
   WS_API_KEY=
   LLM_API_KEY=
   WS_HOST=0.0.0.0
   WS_PORT=9001
   HTTP_PORT=8080   # agent http server

6) Docker
   docker-compose.yml must start:
     - postgres
     - mcp server
     - agent (FastAPI HTTP API)

   Expose:
     - 5432 (Postgres)
     - 9001 (MCP WebSocket server)
     - 8080 (Agent HTTP API)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Output Format (IMPORTANT)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Generate **only code blocks**, no explanation, in this order:

1. pyproject.toml (Poetry config)
2. .env.example
3. Full source code files:
   - src/mcp_server/config.py
   - src/mcp_server/db.py
   - src/mcp_server/tools.py
   - src/mcp_server/ws_server.py
   - src/mcp_server/main.py
   - src/agent/ws_client.py
   - src/agent/http_api.py
4. Dockerfile
5. docker-compose.yml
6. README.md (include setup steps, run commands, and curl example)

BEGIN by generating:
â¡ï¸ `pyproject.toml`